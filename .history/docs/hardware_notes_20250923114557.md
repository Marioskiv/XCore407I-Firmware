# XCore407I Custom Board – Hardware & Firmware Reference

## 1. MCU Core
- STM32F407 (176‑pin, high‑density) @168 MHz (PLL from 8 MHz HSE)
- LSE 32.768 kHz for RTC (VBAT coin cell backup)
- Flash latency: 5 WS with ART prefetch & caches enabled
- Boot0 jumper for system bootloader, hardware RESET pushbutton

### Clock Domains
| Clock | Source | Usage |
|-------|--------|-------|
| HSE 8 MHz | Crystal | PLL input |
| LSE 32.768 kHz | Crystal | RTC |
| SYSCLK 168 MHz | PLL | CPU / AHB |
| APB1 42 MHz | Prescaler | Timers (x2 factor), peripherals |
| APB2 84 MHz | Prescaler | High‑speed peripherals |
| RMII REF_CLK 50 MHz | PHY→MCU (PA1) | Ethernet MAC timing |
| ULPI 60 MHz | USB3300→MCU (PA5) | USB HS ULPI |

## 2. Ethernet (DP83848I – RMII)
| Signal  | STM32 Pin | Dir | Notes |
|---------|-----------|-----|-------|
| REF_CLK | PA1       | In  | 50 MHz from PHY (strap dependent) |
| MDIO    | PA2       | I/O | Management data |
| CRS_DV  | PA7       | In  | Carrier Sense / Data Valid |
| MDC     | PC1       | Out | Management clock |
| RXD0    | PC4       | In  | Receive Data 0 |
| RXD1    | PC5       | In  | Receive Data 1 |
| TX_EN   | PB11      | Out | Transmit Enable (schematic default) |
| TXD0    | PB12      | Out | TX Data 0 (conflicts with ULPI_D5) |
| TXD1    | PB13      | Out | TX Data 1 (conflicts with ULPI_D6) |
| RESET   | (NRST)    | In  | RESET_N tied to MCU NRST (no independent GPIO) |
| LEDs    | PHY pads  | Link / Activity / Speed |

### Critical Points
1. PB12 / PB13 Conflict: Shared with ULPI_D5/D6. Cannot use Ethernet RMII and full ULPI simultaneously unless hardware multiplexing exists.
2. TX_EN Routing: Schematic shows PB11. Legacy reference designs sometimes used PG11; firmware now defaults to PB11 (`USE_PG11_TXEN=0`).
3. PHY Reset: RESET_N tied to NRST; firmware cannot pulse a dedicated reset (unless `ETH_PHY_HAS_DEDICATED_RESET=1` on a variant board). Insert only a startup delay.
4. Strap Sampling: Occurs during system reset release; ensure pull resistors for RMII mode & PHY address are present.
5. REF_CLK Stability: Without valid 50 MHz on PA1, MAC DMA will not function though a switch may show link.
6. MDIO Address Ambiguity: Full scan (0..31) selects first valid responding PHY; bitmap stored.
7. Auto-Neg vs Forced Mode: After prolonged failures, forcing 100M Full Duplex may help.

### Bring-Up Sequence (Recommended)
1. Enable GPIO clocks.
2. Assert PHY reset PG13 low ≥10 ms.
3. Release reset; delay 50 ms (strap latch + oscillator settle).
4. Configure RMII pins to AF11.
5. MDIO scan → bitmap & choose PHY address.
6. `HAL_ETH_Init()` / `HAL_ETH_Start()`.
7. Poll BSR or schedule auto-neg restarts if link remains down.
8. After 30 s continuous down → forced 100M Full Duplex fallback.

### Diagnostic LED Patterns (Implemented / Planned)
| Situation | Pattern |
|-----------|---------|
| Boot signature | 3 fast GREEN blinks |
| PHY address (addr+1) | N short GREEN blinks |
| MDIO responding PHY count | RED blinks = count (0 => 1 long RED) |
| Link up event | 2 quick GREEN pulses (planned) |
| Link down event | 2 quick RED pulses (planned) |
| Link down >5 s | Slow GREEN blink |
| Link down >8 s | Alternating RED/GREEN (strong) |
| Auto-neg restart | Brief RED pulse |
| Forced 100M FD entry | 3 quick RED + 1 long GREEN (planned) |

### Troubleshooting Matrix
| Symptom | Likely Cause | Action |
|---------|--------------|--------|
| ARP requests, no replies | MAC RX dead / no REF_CLK | Probe PA1 50 MHz; check descriptors init |
| No PHY ID detected | MDIO pull-ups / wrong address | Scan all addresses; verify MDIO lines |
| Intermittent link flaps | Reset glitch / power dip / EMI | Extend reset pulse, add decoupling, shield pairs |
| Host sees carrier but MCU thinks down | Wrong PHY addr for BSR or stale strap | Iterate addresses each poll; verify strap resistors |
| Forced mode also fails | Physical layer fault / magnetics | Check magnetics termination & cable |

### Forced Mode Configuration (DP83848 BCR)
- Disable Autoneg: clear bit12
- Speed 100M: set bit13
- Duplex Full: set bit8
- Ensure bit15 (reset) not set inadvertently

## 3. USB HS (USB3300 ULPI)
| Signal  | STM32 Pin | Notes |
|---------|-----------|-------|
| ULPI_D0 | PA3 | |
| ULPI_D1 | PB0 | |
| ULPI_D2 | PB1 | |
| ULPI_D3 | PB10 | |
| ULPI_D4 | PB11 | |
| ULPI_D5 | PB12 (conflict) | With TXD0 |
| ULPI_D6 | PB13 (conflict) | With TXD1 |
| ULPI_D7 | PB5 | |
| ULPI_CK | PA5 | 60 MHz from PHY |
| DIR     | PC2 | |
| NXT     | PC3 | |
| STP     | PC0 | |
| RESET   | (GPIO) | Keep low until supplies stable |

If Ethernet primary: do not enable ULPI AF on PB12/PB13 to avoid bus contention.

## 4. NAND Flash (K9F1G08U0C via FSMC 8‑bit)
| Role | Pins | Notes |
|------|------|-------|
| Data D0–D7 | PD14, PD15, PD0, PD1, PE7–PE10 | FSMC 8‑bit bus |
| NOE / NWE | PD4 / PD5 | Read / Write strobes |
| CE | PD7 | Chip enable |
| CLE / ALE | PD12 / PD11 | Command / Address latch |
| R/B | PD6 | Ready/Busy input |
| WP | (GPIO, pull-up) | Active low write protect |

Initial FSMC timings should be conservative; later tune (address/data setup, hold, turnaround).

## 5. Power & Decoupling
- 3.3 V main rail (MCU I/O, Ethernet PHY, USB I/O, NAND)
- 1.8 V for USB HS PHY core
- Adequate bulk (≥10 µF) + local 100 nF at each VDD/VSS pair & PHY analog supply
- Clean analog ground reference for Ethernet if layout isolates analog sections
- Magnetics center-tap properly biased (per DP83848 ref design)

## 6. Reset / Sequencing Best Practices
1. Apply stable 3.3 V and clocks.
2. Hold PHY in reset while MCU boots.
3. Release PHY reset, wait oscillator settle (50 ms typical).
4. Only then configure RMII Alternate Functions.
5. Start MAC + DMA; begin link monitoring.

## 7. Firmware Features (Current / Planned)
| Feature | Status |
|---------|--------|
| MDIO scan + bitmap | Done |
| PHY ID snapshot | Done |
| Link poll + AN restarts | Done |
| Strong link-down pattern | Done |
| Auto-neg restart pulses | Done |
| Link transition pulses | Planned (this patch) |
| Forced 100M FD fallback | Planned (this patch) |
| Multi-address BSR selection | Planned (this patch) |
| Telemetry counters (AN / forced) | Future |
| Raw ARP emit self-test | Future |

## 8. Next Firmware Patch Outline
1. Implement `ETH_AnyLinkUp()` scanning all valid PHY addresses (bitmap) each poll.
2. Add forced fallback after continuous 30 s down (set BCR bits). LED pattern marking entry.
3. Introduce link transition pulse state machine (non-blocking).
4. Provide prototypes in board header so main can call new helpers.
5. (Optional future) Expose counters via Remora extension telemetry.

## 9. Debug Tips
- Probe PA1 with oscilloscope: Expect clean 50 MHz square. If absent → check PHY clock source & strap.
- If MAC RX dead: inspect ETH DMA descriptor ring after `HAL_ETH_Start()` (ownership bits).
- Remove blocking `HAL_Delay()` calls inside main loop critical sections; use tick deltas.
- If continuous link flaps: check PG13 waveform & EMI on RMII lines.

## 10. Checklist
- [ ] Confirm PB12/PB13 not driven by ULPI while using Ethernet.
- [ ] REF_CLK present (oscilloscope)
- [ ] PHY reset low ≥10 ms, release, 50 ms settle
- [ ] MDIO scan finds expected address (0x01 default if strapped)
- [ ] BSR shows link before attempting higher-layer tests
- [ ] ARP reply validated before UDP protocol usage

---
### Schematic Reconciliation Addendum

## 11. Header Pin Cross‑Reference ("Pin Port" Resource)

Cross table between functional firmware signals and 2x35 header positions from `Pin Port` schematic JSON. This helps during wiring / probing.

| Function | MCU Pin | Header Pin # | Notes / Conflicts |
|----------|---------|--------------|-------------------|
| X STEP | PB6 | 25 | OK |
| X DIR | PB7 | 26 | OK |
| X ENA | PD0 | 51 | FSMC_D2 (conflict if NAND/FSMC active) |
| X ALM | PE0 | 67 | FSMC_NBL0 (conflict) |
| Y STEP | PB8 | 27 | OK |
| Y DIR | PB9 | 28 | OK |
| Y ENA | PD1 | 52 | FSMC_D3 (conflict) |
| Y ALM | PE1 | 68 | FSMC_NBL1 (conflict) |
| Z STEP | PA6 | 9  | Shares SPI1_MISO alt (unused) |
| Z DIR | PB14 | 33 | SPI2_MISO / TIM12_CH1 alt; OK (no ULPI on PB14) |
| Z ENA | PD2 | 53 | SDIO_CMD alt (avoid SDIO) |
| Z ALM | PE2 | —  | Not on 70‑pin header (internal only) |
| A STEP | PC6 | 41 | SDIO_D6 alt (avoid SDIO) |
| A DIR | PC7 | 42 | SDIO_D7 alt |
| A ENA | PD3 | 54 | FSMC_CLK alt (conflict if broad FSMC) |
| A ALM | PE3 | —  | Not on 70‑pin header |
| E‑Stop | PE4 | —  | FSMC_A20 (not on header) |
| Probe | PG0 | —  | FSMC_A10 (not on header) |
| Jog +X | PF0 | —  | FSMC_A0 (not on header) |
| Jog -X | PF1 | —  | FSMC_A1 |
| Jog +Y | PF2 | —  | FSMC_A2 |
| Jog -Y | PF3 | —  | FSMC_A3 |
| Jog +Z | PF4 | —  | FSMC_A4 |
| Jog -Z | PF5 | —  | FSMC_A5 |
| Jog +A | PF6 | —  | TIM10_CH1 / FSMC_NIORD |
| Jog -A | PF7 | —  | TIM11_CH1 / FSMC_NREG |
| ETH REF_CLK | PA1 | 4 | OK |
| ETH MDIO | PA2 | 5 | OK |
| ETH CRS_DV | PA7 | 10 | OK (CRS_DV alt) |
| ETH MDC | PC1 | 36 | OK |
| ETH RXD0 | PC4 | 39 | OK |
| ETH RXD1 | PC5 | 40 | OK |
| ETH TX_EN | PB11 | 30 | Default now PB11 |
| ETH TXD0 | PB12 | 31 | Conflict with ULPI_D5 |
| ETH TXD1 | PB13 | 32 | Conflict with ULPI_D6 |
| ULPI_STP | PC0 | 35 | Only if ULPI enabled |
| ULPI_DIR | PC2 | 37 | Only if ULPI enabled |
| ULPI_NXT | PC3 | 38 | Only if ULPI enabled |
| ULPI_D0 | PA3 | 6 | Shared with USART2_RX alt |
| ULPI_D1 | PB0 | 19 |  |
| ULPI_D2 | PB1 | 20 |  |
| ULPI_D3 | PB10 | 29 |  |
| ULPI_D4 | PB11 | 30 | Overlaps TX_EN if PG11 variant not used |
| ULPI_D5 | PB12 | 31 | Overlaps ETH_TXD0 |
| ULPI_D6 | PB13 | 32 | Overlaps ETH_TXD1 |
| ULPI_D7 | PB5 | 24 |  |

Observations:
1. Many motion FAULT/ENA/JOG lines reside on FSMC address/data pins not fully broken out (some not present on header). This limits simultaneous use of full NAND + external memory with current mapping.
2. PE2–PE3 (A/Z ALM) and PE4 (E‑Stop) not on the 70‑pin header: external access requires test pads or alternative wiring.
3. Recommended for future “FSMC‑compatible” profile: migrate ENA/ALM/Jog to a contiguous free port (e.g. PGx / PHx if available on a carrier) and reserve all PD/PE/PF for memory.
4. If exposing signals externally is a priority, consider reassigning Probe and E‑Stop to header‑available pins (e.g. spare PC8/PC9 if SDIO unused) and moving Z DIR off PB14 if HS USB planned.

### Quick Remap Candidate Set (when enabling NAND)
| Role | Current | Suggested Alt (Header) | Rationale |
|------|---------|------------------------|-----------|
| X ENA | PD0 | PA4 (7) or PC8 (43) | Frees FSMC_D2 |
| Y ENA | PD1 | PA15 (18) | Frees FSMC_D3 |
| X/Y ALM | PE0/PE1 | PC8/PC9 (43/44) | Frees NBL0/1 |
| Probe | PG0 | PA4 / PB4 | Header access |
| E‑Stop | PE4 | PB2 | Keep critical input on header |

These are illustrative; confirm no peripheral conflicts (SPI1_NSS, JTAG, etc.) before adopting.


