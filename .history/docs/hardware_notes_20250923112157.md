# XCore407I Custom Board – Hardware & Firmware Reference

## 1. MCU Core
- STM32F407 (176‑pin, high‑density) @168 MHz (PLL from 8 MHz HSE)
- LSE 32.768 kHz for RTC (VBAT coin cell backup)
- Flash latency: 5 WS with ART prefetch & caches enabled
- Boot0 jumper for system bootloader, hardware RESET pushbutton

### Clock Domains
| Clock | Source | Usage |
|-------|--------|-------|
| HSE 8 MHz | Crystal | PLL input |
| LSE 32.768 kHz | Crystal | RTC |
| SYSCLK 168 MHz | PLL | CPU / AHB |
| APB1 42 MHz | Prescaler | Timers (x2 factor), peripherals |
| APB2 84 MHz | Prescaler | High‑speed peripherals |
| RMII REF_CLK 50 MHz | PHY→MCU (PA1) | Ethernet MAC timing |
| ULPI 60 MHz | USB3300→MCU (PA5) | USB HS ULPI |

## 2. Ethernet (DP83848I – RMII)
| Signal  | STM32 Pin | Dir | Notes |
|---------|-----------|-----|-------|
| REF_CLK | PA1       | In  | 50 MHz from PHY (strap dependent) |
| MDIO    | PA2       | I/O | Management data |
| CRS_DV  | PA7       | In  | Carrier Sense / Data Valid |
| MDC     | PC1       | Out | Management clock |
| RXD0    | PC4       | In  | Receive Data 0 |
| RXD1    | PC5       | In  | Receive Data 1 |
| TX_EN   | PG11      | Out | Transmit Enable |
| TXD0    | PB12      | Out | TX Data 0 (conflicts with ULPI_D5) |
| TXD1    | PB13      | Out | TX Data 1 (conflicts with ULPI_D6) |
| RESET   | PG13*     | Out | Active low (≥10–50 ms) *If schematic variant ties RESET_N to NRST, set ETH_PHY_HAS_DEDICATED_RESET=0 |
| LEDs    | PHY pads  | Link / Activity / Speed |

### Critical Points
1. PB12 / PB13 Conflict: Shared with ULPI_D5/D6. Cannot use Ethernet RMII and full ULPI simultaneously unless hardware multiplexing exists. If Ethernet selected, keep ULPI pins as GPIO input or analog (no AF).
2. PHY Strap Sampling: Occurs immediately after RESET release. Keep RMII data pins as GPIO (not AF) until after ≥5–10 ms from reset deassert so strap resistors are correctly latched. If no dedicated reset pin (RESET_N tied to NRST), rely on power‑on timing and add a fixed delay before AF config.
3. REF_CLK Stability: Without valid 50 MHz on PA1, MAC DMA will not function (no frame RX/TX). Host side may still show carrier via switch parallel detection, causing confusion.
4. MDIO Address Ambiguity: Use full scan (0..31). First valid ID (reg2 != 0x0000/0xFFFF) selected as active PHY. Maintain bitmap for diagnostics.
5. Auto-Neg vs Forced Mode: After prolonged failures, forcing 100M Full Duplex (disable autoneg) can salvage link if negotiation handshake fails.

### Bring-Up Sequence (Recommended)
1. Enable GPIO clocks.
2. Assert PHY reset PG13 low ≥10 ms.
3. Release reset; delay 50 ms (strap latch + oscillator settle).
4. Configure RMII pins to AF11.
5. MDIO scan → bitmap & choose PHY address.
6. `HAL_ETH_Init()` / `HAL_ETH_Start()`.
7. Poll BSR or schedule auto-neg restarts if link remains down.
8. After 30 s continuous down → forced 100M Full Duplex fallback.

### Diagnostic LED Patterns (Implemented / Planned)
| Situation | Pattern |
|-----------|---------|
| Boot signature | 3 fast GREEN blinks |
| PHY address (addr+1) | N short GREEN blinks |
| MDIO responding PHY count | RED blinks = count (0 => 1 long RED) |
| Link up event | 2 quick GREEN pulses (planned) |
| Link down event | 2 quick RED pulses (planned) |
| Link down >5 s | Slow GREEN blink |
| Link down >8 s | Alternating RED/GREEN (strong) |
| Auto-neg restart | Brief RED pulse |
| Forced 100M FD entry | 3 quick RED + 1 long GREEN (planned) |

### Troubleshooting Matrix
| Symptom | Likely Cause | Action |
|---------|--------------|--------|
| ARP requests, no replies | MAC RX dead / no REF_CLK | Probe PA1 50 MHz; check descriptors init |
| No PHY ID detected | MDIO pull-ups / wrong address | Scan all addresses; verify MDIO lines |
| Intermittent link flaps | Reset glitch / power dip / EMI | Extend reset pulse, add decoupling, shield pairs |
| Host sees carrier but MCU thinks down | Wrong PHY addr for BSR or stale strap | Iterate addresses each poll; verify strap resistors |
| Forced mode also fails | Physical layer fault / magnetics | Check magnetics termination & cable |

### Forced Mode Configuration (DP83848 BCR)
- Disable Autoneg: clear bit12
- Speed 100M: set bit13
- Duplex Full: set bit8
- Ensure bit15 (reset) not set inadvertently

## 3. USB HS (USB3300 ULPI)
| Signal  | STM32 Pin | Notes |
|---------|-----------|-------|
| ULPI_D0 | PA3 | |
| ULPI_D1 | PB0 | |
| ULPI_D2 | PB1 | |
| ULPI_D3 | PB10 | |
| ULPI_D4 | PB11 | |
| ULPI_D5 | PB12 (conflict) | With TXD0 |
| ULPI_D6 | PB13 (conflict) | With TXD1 |
| ULPI_D7 | PB5 | |
| ULPI_CK | PA5 | 60 MHz from PHY |
| DIR     | PC2 | |
| NXT     | PC3 | |
| STP     | PC0 | |
| RESET   | (GPIO) | Keep low until supplies stable |

If Ethernet primary: do not enable ULPI AF on PB12/PB13 to avoid bus contention.

## 4. NAND Flash (K9F1G08U0C via FSMC 8‑bit)
| Role | Pins | Notes |
|------|------|-------|
| Data D0–D7 | PD14, PD15, PD0, PD1, PE7–PE10 | FSMC 8‑bit bus |
| NOE / NWE | PD4 / PD5 | Read / Write strobes |
| CE | PD7 | Chip enable |
| CLE / ALE | PD12 / PD11 | Command / Address latch |
| R/B | PD6 | Ready/Busy input |
| WP | (GPIO, pull-up) | Active low write protect |

Initial FSMC timings should be conservative; later tune (address/data setup, hold, turnaround).

## 5. Power & Decoupling
- 3.3 V main rail (MCU I/O, Ethernet PHY, USB I/O, NAND)
- 1.8 V for USB HS PHY core
- Adequate bulk (≥10 µF) + local 100 nF at each VDD/VSS pair & PHY analog supply
- Clean analog ground reference for Ethernet if layout isolates analog sections
- Magnetics center-tap properly biased (per DP83848 ref design)

## 6. Reset / Sequencing Best Practices
1. Apply stable 3.3 V and clocks.
2. Hold PHY in reset while MCU boots.
3. Release PHY reset, wait oscillator settle (50 ms typical).
4. Only then configure RMII Alternate Functions.
5. Start MAC + DMA; begin link monitoring.

## 7. Firmware Features (Current / Planned)
| Feature | Status |
|---------|--------|
| MDIO scan + bitmap | Done |
| PHY ID snapshot | Done |
| Link poll + AN restarts | Done |
| Strong link-down pattern | Done |
| Auto-neg restart pulses | Done |
| Link transition pulses | Planned (this patch) |
| Forced 100M FD fallback | Planned (this patch) |
| Multi-address BSR selection | Planned (this patch) |
| Telemetry counters (AN / forced) | Future |
| Raw ARP emit self-test | Future |

## 8. Next Firmware Patch Outline
1. Implement `ETH_AnyLinkUp()` scanning all valid PHY addresses (bitmap) each poll.
2. Add forced fallback after continuous 30 s down (set BCR bits). LED pattern marking entry.
3. Introduce link transition pulse state machine (non-blocking).
4. Provide prototypes in board header so main can call new helpers.
5. (Optional future) Expose counters via Remora extension telemetry.

## 9. Debug Tips
- Probe PA1 with oscilloscope: Expect clean 50 MHz square. If absent → check PHY clock source & strap.
- If MAC RX dead: inspect ETH DMA descriptor ring after `HAL_ETH_Start()` (ownership bits).
- Remove blocking `HAL_Delay()` calls inside main loop critical sections; use tick deltas.
- If continuous link flaps: check PG13 waveform & EMI on RMII lines.

## 10. Checklist
- [ ] Confirm PB12/PB13 not driven by ULPI while using Ethernet.
- [ ] REF_CLK present (oscilloscope)
- [ ] PHY reset low ≥10 ms, release, 50 ms settle
- [ ] MDIO scan finds expected address (0x01 default if strapped)
- [ ] BSR shows link before attempting higher-layer tests
- [ ] ARP reply validated before UDP protocol usage

---
### Schematic Reconciliation Addendum
Provided schematic JSON indicates:
- TX_EN net to PB11 (legacy layout) while firmware default uses PG11. To align with schematic build with `-DUSE_PG11_TXEN=0`.
- RESET_N may be hard-wired to NRST; if so define `-DETH_PHY_HAS_DEDICATED_RESET=0` to skip PG13 toggle.
- INT/PWRDOWN line not wired → `ETH_PHY_INT_PRESENT=0` (default). If later wired, set pin macros and enable.

Document version: 1.1 (Cross-check & reconciliation updates)
