# XCore407I Custom Board – Hardware & Firmware Reference

## 1. MCU Core
- STM32F407 (176‑pin, high‑density) @168 MHz (PLL from 8 MHz HSE)
- LSE 32.768 kHz for RTC (VBAT coin cell backup)
- Flash latency: 5 WS with ART prefetch & caches enabled
- Boot0 jumper for system bootloader, hardware RESET pushbutton

### Clock Domains
| Clock | Source | Usage |
|-------|--------|-------|
| HSE 8 MHz | Crystal | PLL input |
| LSE 32.768 kHz | Crystal | RTC |
| SYSCLK 168 MHz | PLL | CPU / AHB |
| APB1 42 MHz | Prescaler | Timers (x2 factor), peripherals |
| APB2 84 MHz | Prescaler | High‑speed peripherals |
| RMII REF_CLK 50 MHz | PHY→MCU (PA1) | Ethernet MAC timing |
| ULPI 60 MHz | USB3300→MCU (PA5) | USB HS ULPI |

## 2. Ethernet (DP83848I – RMII)
| Signal  | STM32 Pin | Dir | Notes |
|---------|-----------|-----|-------|
| REF_CLK | PA1       | In  | 50 MHz from PHY (strap dependent) |
| MDIO    | PA2       | I/O | Management data |
| CRS_DV  | PA7       | In  | Carrier Sense / Data Valid |
| MDC     | PC1       | Out | Management clock |
| RXD0    | PC4       | In  | Receive Data 0 |
| RXD1    | PC5       | In  | Receive Data 1 |
| TX_EN   | PB11      | Out | Transmit Enable (schematic default) |
| TXD0    | PB12      | Out | TX Data 0 (conflicts with ULPI_D5) |
| TXD1    | PB13      | Out | TX Data 1 (conflicts with ULPI_D6) |
| RESET   | (NRST)    | In  | RESET_N tied to MCU NRST (no independent GPIO) |
| LEDs    | PHY pads  | Link / Activity / Speed |

### Critical Points
1. PB12 / PB13 Conflict: Shared with ULPI_D5/D6. Cannot use Ethernet RMII and full ULPI simultaneously unless hardware multiplexing exists.
2. TX_EN Routing: Schematic shows PB11. Legacy reference designs sometimes used PG11; firmware now defaults to PB11 (`USE_PG11_TXEN=0`).
3. PHY Reset: RESET_N tied to NRST; firmware cannot pulse a dedicated reset (unless `ETH_PHY_HAS_DEDICATED_RESET=1` on a variant board). Insert only a startup delay.
4. Strap Sampling: Occurs during system reset release; ensure pull resistors for RMII mode & PHY address are present.
5. REF_CLK Stability: Without valid 50 MHz on PA1, MAC DMA will not function though a switch may show link.
6. MDIO Address Ambiguity: Full scan (0..31) selects first valid responding PHY; bitmap stored.
7. Auto-Neg vs Forced Mode: After prolonged failures, forcing 100M Full Duplex may help.

### Bring-Up Sequence (Recommended)
1. Enable GPIO clocks.
2. Assert PHY reset PG13 low ≥10 ms.
3. Release reset; delay 50 ms (strap latch + oscillator settle).
4. Configure RMII pins to AF11.
5. MDIO scan → bitmap & choose PHY address.
6. `HAL_ETH_Init()` / `HAL_ETH_Start()`.
7. Poll BSR or schedule auto-neg restarts if link remains down.
8. After 30 s continuous down → forced 100M Full Duplex fallback.

### Diagnostic LED Patterns (Implemented / Planned)
| Situation | Pattern |
|-----------|---------|
| Boot signature | 3 fast GREEN blinks |
| PHY address (addr+1) | N short GREEN blinks |
| MDIO responding PHY count | RED blinks = count (0 => 1 long RED) |
| Link up event | 2 quick GREEN pulses (planned) |
| Link down event | 2 quick RED pulses (planned) |
| Link down >5 s | Slow GREEN blink |
| Link down >8 s | Alternating RED/GREEN (strong) |
| Auto-neg restart | Brief RED pulse |
| Forced 100M FD entry | 3 quick RED + 1 long GREEN (planned) |

### Troubleshooting Matrix
| Symptom | Likely Cause | Action |
|---------|--------------|--------|
| ARP requests, no replies | MAC RX dead / no REF_CLK | Probe PA1 50 MHz; check descriptors init |
| No PHY ID detected | MDIO pull-ups / wrong address | Scan all addresses; verify MDIO lines |
| Intermittent link flaps | Reset glitch / power dip / EMI | Extend reset pulse, add decoupling, shield pairs |
| Host sees carrier but MCU thinks down | Wrong PHY addr for BSR or stale strap | Iterate addresses each poll; verify strap resistors |
| Forced mode also fails | Physical layer fault / magnetics | Check magnetics termination & cable |

### Forced Mode Configuration (DP83848 BCR)
- Disable Autoneg: clear bit12
- Speed 100M: set bit13
- Duplex Full: set bit8
- Ensure bit15 (reset) not set inadvertently

## 3. USB HS (USB3300 ULPI)
| Signal  | STM32 Pin | Notes |
|---------|-----------|-------|
| ULPI_D0 | PA3 | |
| ULPI_D1 | PB0 | |
| ULPI_D2 | PB1 | |
| ULPI_D3 | PB10 | |
| ULPI_D4 | PB11 | |
| ULPI_D5 | PB12 (conflict) | With TXD0 |
| ULPI_D6 | PB13 (conflict) | With TXD1 |
| ULPI_D7 | PB5 | |
| ULPI_CK | PA5 | 60 MHz from PHY |
| DIR     | PC2 | |
| NXT     | PC3 | |
| STP     | PC0 | |
| RESET   | (GPIO) | Keep low until supplies stable |

If Ethernet primary: do not enable ULPI AF on PB12/PB13 to avoid bus contention.

## 4. NAND Flash (K9F1G08U0C via FSMC 8‑bit)
| Role | Pins | Notes |
|------|------|-------|
| Data D0–D7 | PD14, PD15, PD0, PD1, PE7–PE10 | FSMC 8‑bit bus |
| NOE / NWE | PD4 / PD5 | Read / Write strobes |
| CE | PD7 | Chip enable |
| CLE / ALE | PD12 / PD11 | Command / Address latch |
| R/B | PD6 | Ready/Busy input |
| WP | (GPIO, pull-up) | Active low write protect |

Initial FSMC timings should be conservative; later tune (address/data setup, hold, turnaround).

## 5. Power & Decoupling
- 3.3 V main rail (MCU I/O, Ethernet PHY, USB I/O, NAND)
- 1.8 V for USB HS PHY core
- Adequate bulk (≥10 µF) + local 100 nF at each VDD/VSS pair & PHY analog supply
- Clean analog ground reference for Ethernet if layout isolates analog sections
- Magnetics center-tap properly biased (per DP83848 ref design)

## 6. Reset / Sequencing Best Practices
1. Apply stable 3.3 V and clocks.
2. Hold PHY in reset while MCU boots.
3. Release PHY reset, wait oscillator settle (50 ms typical).
4. Only then configure RMII Alternate Functions.
5. Start MAC + DMA; begin link monitoring.

## 7. Firmware Features (Current / Planned)
| Feature | Status |
|---------|--------|
| MDIO scan + bitmap | Done |
| PHY ID snapshot | Done |
| Link poll + AN restarts | Done |
| Strong link-down pattern | Done |
| Auto-neg restart pulses | Done |
| Link transition pulses | Planned (this patch) |
| Forced 100M FD fallback | Planned (this patch) |
| Multi-address BSR selection | Planned (this patch) |
| Telemetry counters (AN / forced) | Future |
| Raw ARP emit self-test | Future |

## 8. Next Firmware Patch Outline
1. Implement `ETH_AnyLinkUp()` scanning all valid PHY addresses (bitmap) each poll.
2. Add forced fallback after continuous 30 s down (set BCR bits). LED pattern marking entry.
3. Introduce link transition pulse state machine (non-blocking).
4. Provide prototypes in board header so main can call new helpers.
5. (Optional future) Expose counters via Remora extension telemetry.

## 9. Debug Tips
- Probe PA1 with oscilloscope: Expect clean 50 MHz square. If absent → check PHY clock source & strap.
- If MAC RX dead: inspect ETH DMA descriptor ring after `HAL_ETH_Start()` (ownership bits).
- Remove blocking `HAL_Delay()` calls inside main loop critical sections; use tick deltas.
- If continuous link flaps: check PG13 waveform & EMI on RMII lines.

## 10. Checklist
- [ ] Confirm PB12/PB13 not driven by ULPI while using Ethernet.
- [ ] REF_CLK present (oscilloscope)
- [ ] PHY reset low ≥10 ms, release, 50 ms settle
- [ ] MDIO scan finds expected address (0x01 default if strapped)
- [ ] BSR shows link before attempting higher-layer tests
- [ ] ARP reply validated before UDP protocol usage

---
### Schematic Reconciliation Addendum

## 11. Header Pin Cross‑Reference ("Pin Port" Resource)

Cross table between functional firmware signals and 2x35 header positions from `Pin Port` schematic JSON. This helps during wiring / probing.

| Function | MCU Pin | Header Pin # | Notes / Conflicts |
|----------|---------|--------------|-------------------|
| X STEP | PB6 | 25 | OK |
| X DIR | PB7 | 26 | OK |
| X ENA | PD0 | 51 | FSMC_D2 (conflict if NAND/FSMC active) |
| X ALM | PE0 | 67 | FSMC_NBL0 (conflict) |
| Y STEP | PB8 | 27 | OK |
| Y DIR | PB9 | 28 | OK |
| Y ENA | PD1 | 52 | FSMC_D3 (conflict) |
| Y ALM | PE1 | 68 | FSMC_NBL1 (conflict) |
| Z STEP | PA6 | 9  | Shares SPI1_MISO alt (unused) |
| Z DIR | PB14 | 33 | SPI2_MISO / TIM12_CH1 alt; OK (no ULPI on PB14) |
| Z ENA | PD2 | 53 | SDIO_CMD alt (avoid SDIO) |
| Z ALM | PE2 | —  | Not on 70‑pin header (internal only) |
| A STEP | PC6 | 41 | SDIO_D6 alt (avoid SDIO) |
| A DIR | PC7 | 42 | SDIO_D7 alt |
| A ENA | PD3 | 54 | FSMC_CLK alt (conflict if broad FSMC) |
| A ALM | PE3 | —  | Not on 70‑pin header |
| E‑Stop | PE4 | —  | FSMC_A20 (not on header) |
| Probe | PG0 | —  | FSMC_A10 (not on header) |
| Jog +X | PF0 | —  | FSMC_A0 (not on header) |
| Jog -X | PF1 | —  | FSMC_A1 |
| Jog +Y | PF2 | —  | FSMC_A2 |
| Jog -Y | PF3 | —  | FSMC_A3 |
| Jog +Z | PF4 | —  | FSMC_A4 |
| Jog -Z | PF5 | —  | FSMC_A5 |
| Jog +A | PF6 | —  | TIM10_CH1 / FSMC_NIORD |
| Jog -A | PF7 | —  | TIM11_CH1 / FSMC_NREG |
| ETH REF_CLK | PA1 | 4 | OK |
| ETH MDIO | PA2 | 5 | OK |
| ETH CRS_DV | PA7 | 10 | OK (CRS_DV alt) |
| ETH MDC | PC1 | 36 | OK |
| ETH RXD0 | PC4 | 39 | OK |
| ETH RXD1 | PC5 | 40 | OK |
| ETH TX_EN | PB11 | 30 | Default now PB11 |
| ETH TXD0 | PB12 | 31 | Conflict with ULPI_D5 |
| ETH TXD1 | PB13 | 32 | Conflict with ULPI_D6 |
| ULPI_STP | PC0 | 35 | Only if ULPI enabled |
| ULPI_DIR | PC2 | 37 | Only if ULPI enabled |
| ULPI_NXT | PC3 | 38 | Only if ULPI enabled |
| ULPI_D0 | PA3 | 6 | Shared with USART2_RX alt |
| ULPI_D1 | PB0 | 19 |  |
| ULPI_D2 | PB1 | 20 |  |
| ULPI_D3 | PB10 | 29 |  |
| ULPI_D4 | PB11 | 30 | Overlaps TX_EN if PG11 variant not used |
| ULPI_D5 | PB12 | 31 | Overlaps ETH_TXD0 |
| ULPI_D6 | PB13 | 32 | Overlaps ETH_TXD1 |
| ULPI_D7 | PB5 | 24 |  |

Observations:
1. Many motion FAULT/ENA/JOG lines reside on FSMC address/data pins not fully broken out (some not present on header). This limits simultaneous use of full NAND + external memory with current mapping.
2. PE2–PE3 (A/Z ALM) and PE4 (E‑Stop) not on the 70‑pin header: external access requires test pads or alternative wiring.
3. Recommended for future “FSMC‑compatible” profile: migrate ENA/ALM/Jog to a contiguous free port (e.g. PGx / PHx if available on a carrier) and reserve all PD/PE/PF for memory.
4. If exposing signals externally is a priority, consider reassigning Probe and E‑Stop to header‑available pins (e.g. spare PC8/PC9 if SDIO unused) and moving Z DIR off PB14 if HS USB planned.

### Quick Remap Candidate Set (when enabling NAND)
| Role | Current | Suggested Alt (Header) | Rationale |
|------|---------|------------------------|-----------|
| X ENA | PD0 | PA4 (7) or PC8 (43) | Frees FSMC_D2 |
| Y ENA | PD1 | PA15 (18) | Frees FSMC_D3 |
| X/Y ALM | PE0/PE1 | PC8/PC9 (43/44) | Frees NBL0/1 |
| Probe | PG0 | PA4 / PB4 | Header access |
| E‑Stop | PE4 | PB2 | Keep critical input on header |

These are illustrative; confirm no peripheral conflicts (SPI1_NSS, JTAG, etc.) before adopting.

## 12. Motor / Encoder / Safety Signal Header Exposure

Απάντηση στο ερώτημα: «Τα pin port (2x35 header) είναι οι έξοδοι για motors, encoders κλπ;» — Μερικώς. Κάποια σήματα των κινητήρων και των encoders βγαίνουν στο 70‑pin header, αλλά αρκετά σήματα ασφαλείας / jog / probe ΔΕΝ υπάρχουν εκεί (μένουν σε PFx, PGx, PE2..PE4 κλπ).

### 12.1 Stepper Axes
| Άξονας | STEP (MCU) | Header Pin | DIR (MCU) | Header Pin | ENA (MCU) | Header Pin | ALM (MCU) | Header Pin |
|--------|-----------|------------|-----------|------------|-----------|------------|-----------|------------|
| X | PB6 | 25 | PB7 | 26 | PD0 | 51 | PE0 | 67 |
| Y | PB8 | 27 | PB9 | 28 | PD1 | 52 | PE1 | 68 |
| Z | PA6 | 9 | PB14 | 33 | PD2 | 53 | PE2 | — (δεν στο header) |
| A | PC6 | 41 | PC7 | 42 | PD3 | 54 | PE3 | — (δεν στο header) |

Συνεπώς τα ALM των Z/A δεν είναι προσβάσιμα στο μεγάλο header — απαιτείται test pad ή ανακατεύθυνση αν χρειάζονται εξωτερικά.

### 12.2 Encoders
| Encoder | CH1 (MCU) | Header Pin | CH2 (MCU) | Header Pin | Σχόλια |
|---------|-----------|------------|-----------|------------|--------|
| Enc0 (TIM3) | PB4 | 23 | PB5 | 24 | Μοιράζονται με πιθανό SPI2 NSS / I2C alt; ελεύθερα τώρα |
| Enc1 (TIM1) | PA8 | 11 | PA9 | 12 | OK |
| Enc2 (TIM2) | PA15 | 18 | PB3 | 22 | PA15 προσέχεις JTAG/JNTRST αν SWD μόνο |
| Enc3 | — | — | — | — | Δεν έχει διατεθεί (placeholder) |

Όλοι οι υλοποιημένοι encoder δίαυλοι (0..2) είναι προσβάσιμοι στο header.

### 12.3 Jog / Probe / E‑Stop / Fault Inputs
| Σήμα | MCU Pin | Header Pin | Σχόλιο |
|------|---------|------------|--------|
| E‑Stop | PE4 | — | Εσωτερικό μόνο (FSMC_A20 alt) |
| Probe | PG0 | — | Εσωτερικό (FSMC_A10 alt) |
| Jog +X | PF0 | — | Εσωτερικό (FSMC_A0 alt) |
| Jog -X | PF1 | — | Εσωτερικό |
| Jog +Y | PF2 | — | Εσωτερικό |
| Jog -Y | PF3 | — | Εσωτερικό |
| Jog +Z | PF4 | — | Εσωτερικό |
| Jog -Z | PF5 | — | Εσωτερικό |
| Jog +A | PF6 | — | Εσωτερικό |
| Jog -A | PF7 | — | Εσωτερικό |
| X ALM | PE0 | 67 | Στο header |
| Y ALM | PE1 | 68 | Στο header |
| Z ALM | PE2 | — | Εσωτερικό |
| A ALM | PE3 | — | Εσωτερικό |

### 12.4 Συνοπτική Απάντηση
Ναι, τα βασικά STEP/DIR/ENA των τεσσάρων αξόνων και τα περισσότερα encoder κανάλια βγαίνουν στο 2x35 header. Όμως:
1. Τα Alarm (ALM) για Z και A δεν είναι πάνω στο header.
2. Όλα τα JOG inputs, το Probe και το E‑Stop δεν είναι στο header (μένουν σε PF/PG/PE4).
3. Αν χρειάζεσαι αυτά εξωτερικά, πρέπει είτε να γίνει remap σε διαθέσιμα header pins (π.χ. spare PCx) είτε να χρησιμοποιηθεί μικρό daughter board.

### 12.5 Προτεινόμενες Βελτιώσεις (Future Variant)
| Σήμα προς έκθεση | Τρέχον Pin | Υποψήφιο Header Pin | Αιτιολόγηση |
|------------------|------------|---------------------|-------------|
| E‑Stop | PE4 | PB2 (21) | Κρίσιμο safety input να είναι εύκολα διαθέσιμο |
| Probe | PG0 | PC8 (43) ή PC9 (44) | Εάν SDIO δεν χρησιμοποιείται |
| Z ALM | PE2 | PC10 (45) | Διαθέσιμο AF αν δεν χρειαστεί UART4_TX |
| A ALM | PE3 | PC11 (46) | Διαθέσιμο AF αν δεν χρειαστεί UART4_RX |
| Jog multiplex | PF0..PF7 | PC12 / PD8..PD11 | Μείωση χρήσης FSMC lines |

Έτσι απαντάται το «γιατί δεν τα βλέπω όλα στο pin port».

### 12.6 MOTION_PROFILE_FSMC_SAFE
Προστέθηκε build flag `-DMOTION_PROFILE_FSMC_SAFE=1` που:
1. Μετακινεί ENA: X→PA4, Y→PA15, Z→PC8, A→PC9 (απελευθερώνει PD0..PD3 για FSMC D2/D3 κλπ.)
2. Μετακινεί ALM: X→PC10, Y→PC11, Z→PC12, A→PD8 ώστε όλα τα alarms να εμφανίζονται στο header.
3. Μετακινεί E‑Stop σε PB2 (header pin 21).
4. Μετακινεί Probe σε PC8 (ή αφήνεται override).
5. Προσθέτει προειδοποίηση build αν ενεργοποιηθεί NAND χωρίς το προφίλ.

Χρήση:
cmake -B build -DMOTION_PROFILE_FSMC_SAFE=1 -DBOARD_ENABLE_NAND=1 .. && cmake --build build -j

## 13. MCU Pinlist Cross‑Check (Schematic vs Firmware)
Βάσει του αρχείου `MCU` (STM32F407IGT6 LQFP176) επιβεβαιώθηκαν:

| Λειτουργία Firmware | MCU Pin(s) | Schematic Primary Function | Σύγκρουση / Σχόλιο |
|---------------------|-----------|----------------------------|--------------------|
| Ethernet RMII REF_CLK | PA1 | ETH_REFCLK | OK |
| Ethernet MDIO/MDC | PA2 / PC1 | ETH_MDIO / ETH_MDC | OK |
| Ethernet CRS_DV | PA7 | ETH_CRS_DV | OK |
| Ethernet TX_EN / TXD0 / TXD1 | PB11 / PB12 / PB13 | ETH_TX_EN / ETH_TXD0 / ETH_TXD1 | Συγκρούονται με ULPI_D4..D6 (αμοιβαία αποκλειόμενα) |
| STEP X/Y (TIM4 CH1/CH3) | PB6 / PB8 | GPIO | OK (διαθέσιμα) |
| DIR X/Y | PB7 / PB9 | GPIO | OK |
| STEP Z (TIM3 CH1) | PA6 | TIM3_CH1 alt | OK (SPI1_MISO όχι χρησιμοποιείται) |
| DIR Z | PB14 | ULPI_D7 / OTG_HS_DM | Δεν χρησιμοποιούμε ULPI εδώ (Ethernet προτεραιότητα) |
| STEP A (TIM8 CH1) | PC6 | TIM8_CH1 / SDIO_D6 | Απόφυγε SDIO αν χρησιμοποιείται motion |
| DIR A (TIM8 CH2) | PC7 | TIM8_CH2 / SDIO_D7 | idem |
| ENA X/Y/Z/A (default) | PD0..PD3 | FSMC_D2/D3 / SDIO_CMD / FSMC_CLK | Συγκρούσεις με NAND/SDIO (λύνεται από safe profile) |
| ENA (safe profile) | PA4, PA15, PC8, PC9 | SPI1_NSS / JTDI / SDIO_D0/D1 | Αν BOARD_ENABLE_SDIO=1 χρειάζεται άλλη χαρτογράφηση |
| ALM X/Y (default) | PE0 / PE1 | FSMC_NBL0 / FSMC_NBL1 | Συγκρούσεις με NAND (αν απαιτείται) |
| ALM Z/A (default) | PE2 / PE3 | FSMC_A23 / FSMC_A19 | Εσωτερικά μόνο, απελευθερώνονται αν remap |
| ALM (safe profile) | PC10 / PC11 / PC12 / PD8 | SDIO_D2 / SDIO_D3 / SDIO_CK / FSMC_NE1 | Μη συμβατό με SDIO ενεργό |
| E‑Stop (safe) | PB2 | BOOT1 | Προσοχή στο BOOT mode (κρατάται pull‑down/pull‑up σωστά) |
| Probe (safe) | PC8 | SDIO_D0 | Σύγκρουση με SDIO αν ενεργό |
| Jog PF0..PF7 | PF0..PF7 | FSMC_A0..A5 / NIORD / NREG | Αν απαιτηθεί πλήρης FSMC address bus → remap/mux |
| Encoder 0 | PB4 / PB5 | GPIO | OK (προσοχή αν SPI2 ή άλλη λειτουργία) |
| Encoder 1 | PA8 / PA9 | MCO1 / USART1_TX | Χρήση κοινή αποφεύγει MCO1 output |
| Encoder 2 | PA15 / PB3 | JTDI / GPIO | Απαιτεί απενεργοποίηση JTAG, χρήση μόνο SWD (συνήθως ήδη) |
| ULPI data (αν ενεργοποιηθούν) | PA3, PB0, PB1, PB10–PB15 | ULPI_D0..D7 | Συγκρούεται με Ethernet TX pins & DIR Z |
| NAND Data D0..D7 | PD14,PD15,PD0,PD1,PE7–PE10 | FSMC lines | Συγκρούεται με ENA X/Y (default) |
| NAND Control | PD4–PD7,PD11–PD12, PD6 (R/B) | FSMC NOE/NWE/.. | Καμία επιπλέον διάθεση σε motion τώρα |

Key Conflict Axes:
1. Ethernet vs ULPI (PB11–PB13 & PB14). Επιλογή Ethernet σήμερα.
2. Motion default ENA & ALM vs NAND/SDIO. Επιλύεται με `MOTION_PROFILE_FSMC_SAFE` όταν SDIO=0.
3. Safe profile vs SDIO (PC8–PC12). Αν χρειαστεί SDIO, απαιτείται δεύτερο προφίλ (π.χ. `MOTION_PROFILE_SDIO_SAFE`).
4. Encoder 2 χρήση PA15: Απενεργοποιεί πλήρες JTAG (μόνο SWD), κάτι που είναι αποδεκτό στην πλειοψηφία.

Προτεινόμενα επόμενα:
- Εισαγωγή `MOTION_PROFILE_SDIO_SAFE` που θα αποφεύγει PC8–PC12.
- Αυτόματη `#error` όταν BOARD_ENABLE_SDIO && MOTION_PROFILE_FSMC_SAFE && (κάποιο ENA/ALM pin = PC8..PC12).
- Script ελέγχου JSON → header (CI consistency check).


